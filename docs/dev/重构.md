# 数据管道重构方案

## 概述

本次重构的核心目标是：**仅处理 CIF 文件，不再处理 PDB 文件**。整个数据处理流程将分为五个主要阶段，从原始数据下载到最终的鼠源抗原完整结构构建。

## 数据目录结构

```
./data/antigen_antibody/
├── SAbDab/
│   ├── raw/          # 原始下载的 CIF 文件和 TSV 文件
│   ├── cleaned/      # 清理后的 CIF 文件
│   ├── antigen/      # 拆分出的抗原 CIF 文件
│   └── antibody/     # 拆分出的抗体 CIF 文件
├── HumanMouse/       # 人源-鼠源抗原对齐数据
│   └── {human_ag_name}_{chain_id}_{mouse_ag_name}/
│       ├── {human_ag_name}_{chain_id}_{mouse_ag_name}_human_ag_chain.cif
│       └── {human_ag_name}_{chain_id}_{mouse_ag_name}_mouse_ag_chain_aligned.cif
└── MouseAntigen/     # 完整的鼠源抗原结构
    └── {mouse_ag_name}.cif
```

## 处理流程

### 第一步：数据下载与原始数据存储

**目标**：下载所有 SAbDab 中的抗原-抗体复合物 CIF 文件，并准备元数据文件。

**操作**：
1. 从 SAbDab 下载所有抗原-抗体复合物的 CIF 文件
2. 生成表格文件（用于说明这些复合物）
3. 下载原始的 TSV 文件

**存储位置**：`./data/antigen_antibody/SAbDab/raw/`

**输出内容**：
- 所有复合物的 CIF 文件
- 生成的表格文件（说明文件）
- 原始 TSV 文件

---

### 第二步：数据清理

**目标**：根据 TSV 文件中的信息，清理原始 CIF 文件，移除无关的链、辅因子等。

**操作**：
- 读取 TSV 文件中的链信息
- 从原始 CIF 文件中提取并保留相关的抗原链和抗体链
- 删除无关的链、辅因子、水分子等

**存储位置**：`./data/antigen_antibody/SAbDab/cleaned/`

---

### 第三步：拆分抗原与抗体

**目标**：将清理后的复合物 CIF 文件拆分为独立的抗原和抗体文件。

**操作**：
- 从清理后的复合物中提取抗原链，保存为独立的 CIF 文件
- 从清理后的复合物中提取抗体链，保存为独立的 CIF 文件

**存储位置**：
- 抗原：`./data/antigen_antibody/SAbDab/antigen/`
- 抗体：`./data/antigen_antibody/SAbDab/antibody/`

---

### 第四步：人源-鼠源抗原对齐

**目标**：为每个人源抗原找到对应的鼠源抗原，并进行结构对齐。

**操作**：
1. 识别每个人源抗原对应的鼠源抗原
2. 为每对人源-鼠源抗原创建独立的子文件夹
3. 子文件夹命名规则：`{human_ag_name}_{chain_id}_{mouse_ag_name}`
4. 在每个子文件夹中保存两个 CIF 文件：
   - 人源抗原链的 CIF 文件
   - 鼠源抗原链的 CIF 文件（**使用人源抗原链进行对齐**）

**存储位置**：`./data/antigen_antibody/HumanMouse/`

**子文件夹结构示例**：
```
./data/antigen_antibody/HumanMouse/IL2_A_MouseIL2/
├── human_ag_chain.cif          # 人源抗原链
└── mouse_ag_chain_aligned.cif  # 鼠源抗原链（已对齐）
```

---

### 第五步：构建完整的鼠源抗原结构

**目标**：将鼠源抗原的每条链拼接起来，形成完整的鼠源抗原结构。

**操作**：
1. 检查每条鼠源抗原链是否可以拼接
2. 如果可以拼接，将所有链组合成完整的鼠源抗原结构
3. 保存完整的鼠源抗原 CIF 文件

**存储位置**：`./data/antigen_antibody/MouseAntigen/`

**输出内容**：
- 完整的鼠源抗原 CIF 文件（文件名：`{mouse_ag_name}.cif`）

**注意事项**：
- 此步骤需要验证链之间的连接性和结构完整性
- 如果无法拼接，应记录原因并跳过该抗原

---

## 注意事项

- 所有处理步骤仅涉及 CIF 文件，不再生成或处理 PDB 文件
- 对齐操作使用人源抗原链作为参考，鼠源抗原链作为目标
- 确保每个处理步骤的输出都经过验证，保证数据完整性
- 第五步的拼接操作需要仔细验证结构合理性
