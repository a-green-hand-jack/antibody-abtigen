# 数据结构说明

本文档描述 pipeline 运行后生成的数据目录结构和文件格式。

## 目录结构

```
./data/
├── SAbDab/                          # Phase 1-3: SAbDab 数据处理
│   ├── raw/                         # 原始下载的 PDB/CIF 文件
│   │   └── {pdb_id}.cif
│   ├── cleaned/                     # 清洗后的结构（去除水、配体等）
│   │   └── {pdb_id}_cleaned.cif
│   ├── antigen/                     # 提取的抗原链
│   │   └── {pdb_id}_antigen.cif
│   └── antibody/                    # 提取的抗体链
│       └── {pdb_id}_antibody.cif
│
├── MouseAntigen/                    # Phase 4: 鼠源抗原结构
│   └── {mouse_gene}.cif             # 从 RCSB 下载的鼠源抗原
│
├── HumanMouse/                      # Phase 5: 人-鼠抗原配对
│   └── {human_gene}_{mouse_gene}/   # 每个配对一个目录
│       ├── human_ag.cif             # 人源抗原（完整，所有链）
│       ├── mouse_ag_aligned.cif     # 对齐后的鼠源抗原
│       └── metadata.json            # 配对元数据
│
└── human_mouse_pairs.csv            # 完整的三方映射表

./output/
├── dataset_summary.csv              # 所有数据点的处理状态汇总
├── processing_log.json              # 详细处理日志
└── DP_{pdb_id}_{chain}/             # 每个数据点的输出（兼容旧格式）
    ├── *_antibody.pdb/cif
    ├── *_human_ag.pdb/cif
    ├── *_mouse_ag.pdb/cif
    └── metadata.json
```

## 核心文件说明

### human_mouse_pairs.csv

这是最重要的映射文件，包含人源抗原、鼠源抗原、抗体的完整对应关系。

| 列名 | 说明 | 示例 |
|------|------|------|
| pair_name | 配对名称 | GNAO1_Gnao1 |
| pair_dir | 配对目录路径 | HumanMouse/GNAO1_Gnao1 |
| human_antigen_pdb | 人源抗原 PDB ID | 9vje |
| human_antigen_chains | 人源抗原链 ID | B |
| human_antigen_gene | 人源基因名 | GNAO1 |
| human_antigen_uniprot | 人源 UniProt ID | P09471 |
| human_antigen_name | 蛋白名称 | Guanine nucleotide-binding protein G(o) subunit alpha |
| human_antigen_file | 人源抗原文件路径 | SAbDab/antigen/9vje_antigen.cif |
| mouse_antigen_pdb | 鼠源抗原 PDB ID | 3C7K |
| mouse_antigen_chain | 鼠源抗原链 ID | A |
| mouse_antigen_gene | 鼠源基因名 | Gnao1 |
| mouse_antigen_uniprot | 鼠源 UniProt ID | P18872 |
| mouse_antigen_source | 鼠源结构来源 | RCSB |
| mouse_antigen_file | 鼠源抗原文件路径 | MouseAntigen/Gnao1.cif |
| antibody_pdb | 抗体 PDB ID | 9vje |
| antibody_heavy_chain | 抗体重链 ID | E |
| antibody_light_chain | 抗体轻链 ID | e |
| antibody_file | 抗体文件路径 | SAbDab/antibody/9vje_antibody.cif |
| sequence_identity | 人鼠序列同一性 (%) | 96.12 |
| alignment_rmsd | 结构对齐 RMSD (Å) | 2.44 |
| epitope_identity | 表位序列同一性 (%) | - |
| epitope_rmsd | 表位 RMSD (Å) | - |
| epitope_consistent | 表位一致性标记 | - |

**注意**：同一个 `pair_name` 可能有多条记录，因为不同的抗体可能结合同一对人-鼠抗原。这是预期行为，保留了不同抗体的信息。

### HumanMouse/{pair_name}/metadata.json

每个配对目录下的元数据文件：

```json
{
  "pair_name": "GNAO1_Gnao1",
  "pdb_id_human": "9bsb",
  "pdb_id_mouse": "3C7K",
  "human_antigen_chains": ["A", "B"],
  "mouse_antigen_chain": "A",
  "antibody_heavy_chain": "E",
  "antibody_light_chain": "e",
  "human_uniprot": "P09471",
  "mouse_uniprot": "P18872",
  "human_gene_name": "GNAO1",
  "mouse_gene_name": "Gnao1",
  "alignment_rmsd": 2.94,
  "mouse_structure_source": "RCSB",
  "files": {
    "human_ag": "human_ag.cif",
    "mouse_ag_aligned": "mouse_ag_aligned.cif"
  }
}
```

### dataset_summary.csv

处理状态汇总，包含所有尝试处理的数据点：

| 列名 | 说明 |
|------|------|
| id | 数据点 ID (DP_{pdb}_{chain}) |
| status | 处理状态 (success/failed) |
| error_message | 失败原因（如有） |
| sequence_identity | 序列同一性 |
| alignment_rmsd | 对齐 RMSD |
| ... | 其他元数据 |

常见失败原因：
- `No mouse ortholog found` - 未找到鼠源同源物
- `No PDB structure found for mouse ortholog` - 鼠源同源物无 PDB 结构
- `Sequence identity X% below threshold Y%` - 序列同一性低于阈值

## 数据流程

```
SAbDab 下载 → 清洗结构 → 提取抗原/抗体链
                ↓
         UniProt/Ensembl 查询鼠源同源物
                ↓
         下载鼠源抗原结构 (RCSB)
                ↓
         PyMOL/Biopython 结构对齐
                ↓
         生成 HumanMouse 配对目录 + CSV 映射表
```

## 使用示例

```python
import pandas as pd

# 读取映射表
pairs = pd.read_csv('data/human_mouse_pairs.csv')

# 筛选高同一性配对
high_identity = pairs[pairs['sequence_identity'] > 90]

# 获取某配对的文件路径
for _, row in high_identity.iterrows():
    human_ag = f"data/{row['human_antigen_file']}"
    mouse_ag = f"data/{row['mouse_antigen_file']}"
    antibody = f"data/{row['antibody_file']}"
    aligned_mouse = f"data/{row['pair_dir']}/mouse_ag_aligned.cif"
```
